<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-usage/integration">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Integration | TigerBeetle Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.tigerbeetle.com/usage/integration"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Integration | TigerBeetle Docs"><meta data-rh="true" name="description" content="TigerBeetle is designed to guard against bugs not only in its"><meta data-rh="true" property="og:description" content="TigerBeetle is designed to guard against bugs not only in its"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://docs.tigerbeetle.com/usage/integration"><link data-rh="true" rel="alternate" href="https://docs.tigerbeetle.com/usage/integration" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.tigerbeetle.com/usage/integration" hreflang="x-default"><script src="https://plausible.io/js/script.js" defer="defer" data-domain="docs.tigerbeetle.com"></script><link rel="stylesheet" href="/assets/css/styles.58ccdd9a.css">
<link rel="preload" href="/assets/js/runtime~main.a4e84fc5.js" as="script">
<link rel="preload" href="/assets/js/main.0d4035dc.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="TigerBeetle Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="TigerBeetle Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">TigerBeetle Docs</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tigerbeetledb/tigerbeetle" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Getting started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/deployment/with-docker">Deployment</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/usage/node-cli">Usage</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/usage/node-cli">Creating accounts and transfers in the Node CLI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/usage/data-modeling">Data Modeling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/usage/integration">Integration</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/recipes/currency-exchange">Recipes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/reference/accounts">Reference</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/FAQ">FAQ</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Usage</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Integration</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Integration</h1><p>TigerBeetle is designed to guard against bugs not only in its
<a href="https://github.com/tigerbeetledb/tigerbeetle/blob/main/docs/TIGER_STYLE.md" target="_blank" rel="noopener noreferrer">own code</a>, but
at the boundaries, in the application code which interfaces with TigerBeetle.
This is exhibited by the client&#x27;s API design, which may be surprising (see <a href="#retries">Retries</a>) when
contrasted with a more conventional database.</p><p>Strict consistency guarantees (at the database level) simplify application logic and error handling
farther up the stack.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consistency">Consistency<a class="hash-link" href="#consistency" title="Direct link to heading">​</a></h2><p>TigerBeetle provides strict serializability
(<a href="http://www.bailis.org/blog/linearizability-versus-serializability/" target="_blank" rel="noopener noreferrer">serializability + linearizability</a>)
to each <a href="#client-sessions">client session</a>.</p><p>But consistency models can seem arcane.
What specific guarantees does TigerBeetle provide to applications?</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="client-sessions"><a href="#client-sessions">Client Sessions</a><a class="hash-link" href="#client-sessions" title="Direct link to heading">​</a></h4><ul><li>A client session may have at most one in-flight request.</li><li>A client session reads its own writes.</li><li>A client session observes writes in the order that they occur on the cluster.</li><li>A client session observes <a href="/reference/accounts#debits_posted"><code>debits_posted</code></a> and
<a href="/reference/accounts#credits_posted"><code>credits_posted</code></a> as monotonically increasing.
That is, a client session will never see <code>credits_posted</code> or <code>debits_posted</code> decrease.</li><li>A client session never observes uncommitted updates.</li><li>A client session never observes a broken invariant (e.g.
<a href="/reference/accounts#flagscredits_must_not_exceed_debits"><code>flags.credits_must_not_exceed_debits</code></a>
or <a href="/reference/transfers#flagslinked"><code>flags.linked</code></a>).</li><li>Multiple client sessions may receive replies <a href="#reply-order">out of order</a> relative to one another.</li><li>A client session can consider a request executed when it receives a reply for the request.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="requests"><a href="#requests">Requests</a><a class="hash-link" href="#requests" title="Direct link to heading">​</a></h4><ul><li>A request executes within the cluster at most once.</li><li>Requests do not <a href="#retries">time out</a> — a timeout typically implies failure, which cannot be
conclusively determined in the context of network faults.</li><li>Requests retried by their original client session receive identical replies.</li><li>Requests retried by a different client (same request body, different session) may receive
<a href="#consistency-with-foreign-databases">different replies</a>.</li><li>Events within a request are executed in sequential order.</li><li>Events within a request do not interleave with events from other requests.
(TODO: Can timeouts interleave batches, or should we shift the batch so that timeouts land
entirely before/after?)</li><li>All events within a request batch are committed, or none are.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="events"><a href="/reference/operations/">Events</a><a class="hash-link" href="#events" title="Direct link to heading">​</a></h4><ul><li>Once committed, an event will always be committed — the cluster&#x27;s state never backtracks.</li><li>Within a cluster, object timestamps are unique.
For all objects <code>A</code> and <code>B</code> belonging to the same cluster, <code>A.timestamp ≠ B.timestamp</code>.</li><li>Within a cluster, object timestamps are strictly increasing.
For all objects <code>A</code> and <code>B</code> belonging to the same cluster, if <code>A.timestamp &lt; B.timestamp</code>,
then <code>A</code> was committed earlier than <code>B</code>.</li><li>If a client session is terminated and restarts, it is guaranteed to see updates for which the
corresponding reply was received prior to termination.</li><li>If a client session is terminated and restarts, it is <em>not</em> guaranteed to see updates for
which the corresponding reply was <em>not</em> received prior to the restart. Those updates may
occur at any point in the future, or never. Handling application crash recovery safely requires
<a href="#consistency-with-foreign-databases">using <code>id</code>s to idempotently retry events</a>.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="accounts"><a href="/reference/accounts">Accounts</a><a class="hash-link" href="#accounts" title="Direct link to heading">​</a></h4><ul><li>Accounts are immutable — once created, they are never modified
(excluding balance fields, which are modified by transfers).</li><li>There is at most one <code>Account</code> with a particular <code>id</code>.</li><li>The sum of all accounts&#x27; <code>debits_pending</code> equals the sum of all accounts&#x27; <code>credits_pending</code>.</li><li>The sum of all accounts&#x27; <code>debits_posted</code> equals the sum of all accounts&#x27; <code>credits_posted</code>.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="transfers"><a href="/reference/transfers">Transfers</a><a class="hash-link" href="#transfers" title="Direct link to heading">​</a></h4><ul><li>Transfers are immutable — once created, they are never modified.</li><li>There is at most one <code>Transfer</code> with a particular <code>id</code>.</li><li>A <a href="/reference/transfers#pending-transfer">pending transfer</a> resolves at most once.</li><li>Transfer <a href="/reference/transfers#timeout">timeouts</a> are deterministic, driven
by the cluster&#x27;s timestamp.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="reply-order">Reply Order<a class="hash-link" href="#reply-order" title="Direct link to heading">​</a></h3><p>Replies to a client session always arrive in order — a client session may have only one request
in-flight, and clients ignore (duplicate) replies to their prior requests.</p><ul><li>Requests are executed in the order they arrive at the cluster&#x27;s primary.</li><li>Replies to different clients may arrive out of order.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="example">Example<a class="hash-link" href="#example" title="Direct link to heading">​</a></h4><p>Consider two clients <code>A</code> and <code>B</code>:</p><ol><li>Client <code>A</code> sends request <code>A₁</code>.</li><li>Client <code>B</code> sends request <code>B₁</code>.</li></ol><p>Client <code>A</code> sent its request first, but requests <code>A₁</code> and <code>B₁</code> may execute in either order —
whichever arrives first at the primary will execute first.</p><p>In this diagram, the requests are delivered out of order — <code>B₁</code> then <code>A₁</code>:</p><div class="language-mermaid codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mermaid codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sequenceDiagram</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    autonumber</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    participant Client A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    participant Client B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    participant (Network)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    participant Cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Client A-&gt;&gt;(Network): A₁ (request)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Client B-&gt;&gt;(Network): B₁ (request)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Note over (Network): Request A₁ is delayed by the network.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (Network)-&gt;&gt;Cluster: B₁ (request)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (Network)-&gt;&gt;Cluster: A₁ (request)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Cluster-&gt;&gt;(Network): B₁ (reply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Cluster-&gt;&gt;(Network): A₁ (reply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (Network)-&gt;&gt;Client B: B₁(reply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (Network)-&gt;&gt;Client A: A₁ (reply)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Suppose instead <code>A₁</code> arrives and executes before <code>B₁</code>.
The replies may be delivered in the same order (<code>A₁</code> then <code>B₁</code>), or they may be reordered, as shown below:</p><div class="language-mermaid codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mermaid codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sequenceDiagram</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    autonumber</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    participant Client A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    participant Client B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    participant (Network)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    participant Cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Client A-&gt;&gt;(Network): A₁ (request)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Client B-&gt;&gt;(Network): B₁ (request)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (Network)-&gt;&gt;Cluster: A₁ (request)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (Network)-&gt;&gt;Cluster: B₁ (request)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Cluster-&gt;&gt;(Network): A₁ (reply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Cluster-&gt;&gt;(Network): B₁ (reply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Note over (Network): Reply A₁ is delayed by the network.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (Network)-&gt;&gt;Client B: B₁(reply)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (Network)-&gt;&gt;Client A: A₁ (reply)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="retries">Retries<a class="hash-link" href="#retries" title="Direct link to heading">​</a></h3><p>A <a href="#client-sessions">client session</a> will automatically retry a request until either:</p><ul><li>the client receives a corresponding reply from the cluster, or</li><li>the client is terminated.</li></ul><p>Unlike most database or RPC clients:</p><ul><li>the TigerBeetle client will never time out</li><li>the TigerBeetle client has no retry limits</li><li>the TigerBeetle client does not surface network errors</li></ul><p>With TigerBeetle&#x27;s strict consistency model, surfacing these errors at the client/application level
would be misleading. An error would imply that a request did not execute, when that is not known:</p><ul><li>A request delayed by the network could execute after its timeout.</li><li>A reply delayed by the network could execute before its timeout.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="consistency-with-foreign-databases">Consistency with Foreign Databases<a class="hash-link" href="#consistency-with-foreign-databases" title="Direct link to heading">​</a></h3><p>TigerBeetle objects may correspond to objects in a foreign data store (e.g. another DBMS). Keeping
multiple data stores consistent (in sync) is subtle in the context of application process faults.</p><p>Object creation events are idempotent, but only the first attempt will return <code>.ok</code>,
while all successive identical attempts return <code>.exists</code>. The client may crash after creating
the object, but before receiving the <code>.ok</code> reply. Because the session resets, neither that client
nor any others will see the object&#x27;s corresponding <code>.ok</code> result.</p><p>Therefore, to recover to the correct state after a crash, an application that synchronizes updates
between multiple data stores must treat <code>.exists</code> as equivalent to <code>.ok</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="example-1">Example<a class="hash-link" href="#example-1" title="Direct link to heading">​</a></h4><p>Suppose that an application creates users within Postgres, and for each user a
corresponding <code>Account</code> in TigerBeetle.</p><p>This scenario depicts the typical case:</p><ol><li><em>Application</em>: Create user <code>U₁</code> in Postgres with <code>U₁.account_id = A₁</code> and
<code>U₁.account_exists = false</code>.</li><li><em>Application</em>: Send &quot;create account&quot; request <code>A₁</code> to the cluster.</li><li><em>Cluster</em>: Create <code>A₁</code>; reply <code>ok</code>.</li><li><em>Application</em>: Receive reply <code>A₁: ok</code> from the cluster.</li><li><em>Application</em>: Set <code>U₁.account_exists = true</code>.</li></ol><p>But suppose the application crashes and restarts immediately after sending its request (step 2):</p><ol><li><em>Application</em>: Create user <code>U₁</code> in Postgres with <code>U₁.account_id = A₁</code> and
<code>U₁.account_exists = false</code>.</li><li><em>Application</em>: Send &quot;create account&quot; request <code>A₁</code> to the cluster.</li><li><em>Application</em>: Crash. Restart.</li><li><em>Cluster</em>: Create <code>A₁</code>; reply <code>ok</code> — but the application session has reset,
so this reply never reaches the application).</li><li><em>Application</em>: Send &quot;create account&quot; request <code>A₁</code> to the cluster.</li><li><em>Cluster</em>: Create <code>A₁</code>; reply <code>exists</code>.</li><li><em>Application</em>: Receive reply <code>A₁: exists</code> from the cluster.</li><li><em>Application</em>: Set <code>U₁.account_exists = true</code>.</li></ol><p>In the second case, the application observes that the account is created by receiving <code>.exists</code>
(step 6) instead of <code>.ok</code>.</p><p>Note that the retry (step 5) reused the same account <code>id</code> from the original request (step 2).
An alternate approach is to generate a new account <code>id</code> for each &quot;create account&quot; attempt,
and perhaps store the account&#x27;s <code>id</code> on <code>U₁</code> when it is successfully created.
Then account creation could be restricted to the <code>.ok</code> code — but application restarts would leave
orphaned accounts in TigerBeetle, which may be confusing for auditing and debugging.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="client-sessions-1">Client Sessions<a class="hash-link" href="#client-sessions-1" title="Direct link to heading">​</a></h2><p>A <em>client session</em> is a sequence of alternating <a href="#requests">requests</a> and replies between a client
and a cluster.</p><p>A client session may have at most one in-flight request — i.e. at most one unique request on the
network for which a reply has not been received. This simplifies consistency and allows the cluster
to statically guarantee capacity in its incoming message queue. Additional requests from the
application are queued by the client, to be dequeued and sent when their preceding request receives
a reply.</p><p>TigerBeetle has a <a href="#client-session-eviction">hard limit</a> on the number of concurrent
client sessions, and encourages minimizing the number of concurrent clients to
<a href="#batching-events">maximize throughput</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="client-session-lifecycle">Client Session Lifecycle<a class="hash-link" href="#client-session-lifecycle" title="Direct link to heading">​</a></h3><p>A client session begins when a client registers itself with the cluster.</p><ul><li>Each client session has a unique identifier (&quot;client id&quot;) — an ephemeral random 128-bit id.</li><li>The client sends a special &quot;register&quot; message which is committed by the cluster, at which point
the client is &quot;registered&quot; — once it receives the reply, it may begin sending requests.</li><li>Client registration is handled automatically by the TigerBeetle client implementation when the
client is initialized, before it sends its first request.</li><li>When a client restarts (for example, the application service running the TigerBeetle client is
restarted) it does not resume its old session — it starts a new session, with a new (random)
client id.</li></ul><p>A client session ends when either:</p><ul><li>the client session is <a href="#client-session-eviction">evicted</a>, or</li><li>the client terminates</li></ul><p>— whichever occurs first.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="client-session-eviction">Client Session Eviction<a class="hash-link" href="#client-session-eviction" title="Direct link to heading">​</a></h3><p>When a client session is registering and the number of active sessions in the cluster is already at
the cluster&#x27;s concurrent client session
<a href="https://tigerbeetle.com/blog/a-database-without-dynamic-memory/" target="_blank" rel="noopener noreferrer">limit</a> (<code>config.clients_max</code>,
32 by default), an existing client session must be evicted to make space for
the new session.</p><ul><li>After a session is evicted by the cluster, no future requests from that session will ever execute.</li><li>The evicted session is chosen as the session that committed a request the longest time ago.</li></ul><p>The cluster sends a message to notify the evicted session that it has ended. Typically the evicted
client is no longer active (already terminated), but if it is active, the eviction message causes it
to self-terminate, bubbling up to the application as an <code>session evicted</code> error.</p><p>(TODO: Right now evicted clients panic — fix that so this is accurate.)</p><p>If active clients are terminating with <code>session evicted</code> errors, it (most likely) indicates that
the application is trying to run <a href="#batching-events">too many</a> concurrent clients.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="requests-1">Requests<a class="hash-link" href="#requests-1" title="Direct link to heading">​</a></h2><p>A <em>request</em> is a <a href="#batching-events">batch</a> of one or more
<a href="/reference/operations/">operation events</a> sent to the cluster in a single message.</p><ul><li>All events within a request batch share the same operation type.</li><li>The cluster commits an entire batch at once, each event in series.</li><li>The cluster returns a single reply for each unique request it commits.</li><li>The cluster&#x27;s reply contains results corresponding to each event in the request.</li><li>Unless <a href="/reference/transfers#flagslinked">linked</a>, events within a request
<a href="/reference/operations/create_transfers#result">succeed or fail</a> independently.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="batching-events">Batching Events<a class="hash-link" href="#batching-events" title="Direct link to heading">​</a></h3><p>To achieve high throughput, TigerBeetle amortizes the overhead of consensus and I/O by
batching many operation events in each request. For the best performance, each request should batch
as many events as possible. Typically this means funneling events through fewer client instances.</p><p>The maximum number of events per batch depends on the maximum message size
(<code>config.message_size_max</code>) and the operation type.
(TODO: Expose batch size in the client instead).</p><p>In the default configuration, the batch sizes are:</p><table><thead><tr><th>Operation</th><th align="right">Batch Size</th></tr></thead><tbody><tr><td><code>lookup_accounts</code></td><td align="right">8191</td></tr><tr><td><code>lookup_transfers</code></td><td align="right">8191</td></tr><tr><td><code>create_accounts</code></td><td align="right">8191</td></tr><tr><td><code>create_transfers</code></td><td align="right">8191</td></tr></tbody></table><p>Presently the client application is responsible for batching events, but only as a stopgap
because this has not yet been implemented within the clients themselves.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="api-layer-architecture">API Layer Architecture<a class="hash-link" href="#api-layer-architecture" title="Direct link to heading">​</a></h4><p>In some application architectures, the number of services that need to query TigerBeetle may:</p><ul><li><a href="#client-session-eviction">exceed <code>config.clients_max</code></a>, or</li><li>may require additional <a href="#batching-events">batching</a> to optimize throughput.</li></ul><p>Rather than each service connecting to TigerBeetle directly, application services can forward their
requests to a pool of intermediate services (the &quot;API layer&quot;) which can coalesce events from
many application services into requests, and forward back the respective
replies. This approach enables larger batch sizes and higher throughput, but comes at a cost: the
application services&#x27; sessions are no longer linearizable, because the API services may restart at
any time relative to the application service.</p><div class="language-mermaid codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mermaid codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">flowchart LR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    App1[Application service 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    App2[Application service 2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    App3[Application service 3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    App4[Application service 4]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Cluster[TigerBeetle cluster]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    App1 &lt;--&gt; API1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    App2 &lt;--&gt; API1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    App3 &lt;--&gt; API2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    App4 &lt;--&gt; API2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subgraph API</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        API1{API 1}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        API2{API 2}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    API1 &lt;--&gt; Cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    API2 &lt;--&gt; Cluster</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/tigerbeetledb/tigerbeetle/blob/main/docs/usage/integration.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/usage/data-modeling"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Data Modeling</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/recipes/currency-exchange"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Currency Exchange</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#consistency" class="table-of-contents__link toc-highlight">Consistency</a><ul><li><a href="#reply-order" class="table-of-contents__link toc-highlight">Reply Order</a></li><li><a href="#retries" class="table-of-contents__link toc-highlight">Retries</a></li><li><a href="#consistency-with-foreign-databases" class="table-of-contents__link toc-highlight">Consistency with Foreign Databases</a></li></ul></li><li><a href="#client-sessions-1" class="table-of-contents__link toc-highlight">Client Sessions</a><ul><li><a href="#client-session-lifecycle" class="table-of-contents__link toc-highlight">Client Session Lifecycle</a></li><li><a href="#client-session-eviction" class="table-of-contents__link toc-highlight">Client Session Eviction</a></li></ul></li><li><a href="#requests-1" class="table-of-contents__link toc-highlight">Requests</a><ul><li><a href="#batching-events" class="table-of-contents__link toc-highlight">Batching Events</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/tigerbeetledb" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/tigerbeetledb/tigerbeetle" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://linkedin.com/company/tigerbeetle" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/uWCGp46uG5" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 TigerBeetle, Inc. All rights reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.a4e84fc5.js"></script>
<script src="/assets/js/main.0d4035dc.js"></script>
</body>
</html>